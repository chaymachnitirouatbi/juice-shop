name: DevSecOps CI/CD with DefectDojo

on:
  push:
    branches: [ master ]
  pull_request:

jobs:
  security-pipeline:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Checkout du code
    - name: Checkout code
      uses: actions/checkout@v3

    # 2Ô∏è‚É£ Installer Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install Python dependencies
      run: pip install requests semgrep

    # 3Ô∏è‚É£ D√©finir les IDs DefectDojo
    - name: Set DefectDojo IDs
      run: |
        echo "PRODUCT_ID=5" >> $GITHUB_ENV
        echo "ENGAGEMENT_ID=17" >> $GITHUB_ENV

    # 4Ô∏è‚É£ Installer Node.js
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: "22.12"

    # 5Ô∏è‚É£ Build Juice Shop
    - name: Install dependencies & build
      run: |
        cd frontend
        npm install
        npm run build
        cd ..
        npm install
        npm run build:server

    # 6Ô∏è‚É£ Ex√©cuter SAST (Semgrep)
    - name: Run Semgrep SAST
      run: semgrep --config=auto --json --output semgrep_results.json

    # 7Ô∏è‚É£ Ex√©cuter SCA (npm audit)
    - name: Run npm audit
      run: npm audit --json > npm_audit.json || true

    # 8Ô∏è‚É£ Ex√©cuter DAST (OWASP ZAP)
    - name: Start Juice Shop server
      run: npm start & sleep 20

    - name: Run ZAP Scan
      uses: zaproxy/action-full-scan@v0.7.0
      with:
        target: "http://localhost:3000"
        format: "json"
        output: "zap_result.json"
        allow_issue_writing: false
        cmd_options: "-silent"
        artifact_name: "zap-scan"

    # 9Ô∏è‚É£ Envoi vers DefectDojo
    - name: Upload scans to DefectDojo
      env:
        DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
        DEFECTDOJO_TOKEN: ${{ secrets.DEFECTDOJO_TOKEN }}
        ENGAGEMENT_ID: ${{ env.ENGAGEMENT_ID }}
      run: |
        for item in \
          "semgrep_results.json:Semgrep JSON Report" \
          "npm_audit.json:NPM Audit JSON" \
          "zap_result.json:ZAP Scan"; do

          FILE=${item%%:*}
          TYPE=${item##*:}

          echo "Uploading $FILE to DefectDojo as $TYPE..."

          curl -X POST "$DEFECTDOJO_URL/api/v2/import-scan/" \
            -H "Authorization: Token $DEFECTDOJO_TOKEN" \
            -F "scan_type=$TYPE" \
            -F "file=@$FILE" \
            -F "engagement=$ENGAGEMENT_ID"
        done

    # üîü Upload artifacts
    - name: Upload Semgrep results
      uses: actions/upload-artifact@v4
      with:
        name: semgrep-results
        path: semgrep_results.json

    - name: Upload npm audit results
      uses: actions/upload-artifact@v4
      with:
        name: npm-audit
        path: npm_audit.json

    - name: Upload ZAP results
      uses: actions/upload-artifact@v4
      with:
        name: zap-scan
        path: zap_result.json
