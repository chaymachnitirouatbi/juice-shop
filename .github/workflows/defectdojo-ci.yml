name: DevSecOps CI/CD with DefectDojo

on:
  push:
    branches: [ master ]
  pull_request:

jobs:
  security-pipeline:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout du code
    - name: Checkout code
      uses: actions/checkout@v3

    # 2️⃣ Installer Python pour uploader les scans
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.10"

    - name: Install Python dependencies
      run: pip install requests semgrep

    # 3️⃣ Définir les IDs fixes de produit et engagement (demo publique)
    - name: Set DefectDojo IDs
      run: |
        echo "export PRODUCT_ID=5" >> $GITHUB_ENV
        echo "export ENGAGEMENT_ID=17" >> $GITHUB_ENV

    # 4️⃣ Installer Node.js
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: "22.12"

    # 5️⃣ Build Juice Shop (frontend + serveur)
    - name: Install dependencies & build
      run: |
        cd frontend
        npm install
        npm run build
        cd ..
        npm install
        npm run build:server

    # 6️⃣ Exécuter SAST (Semgrep)
    - name: Run Semgrep SAST
      run: semgrep --config=auto --json --output semgrep_results.json

    # 7️⃣ Exécuter SCA (npm audit)
    - name: Run npm audit
      run: npm audit --json > npm_audit.json

    # 8️⃣ Exécuter DAST (OWASP ZAP)
    - name: Start Juice Shop server
      run: npm start & sleep 20

    - name: Run ZAP Scan
      uses: zaproxy/action-full-scan@v0.7.0
      with:
        target: "http://localhost:3000"
        format: "json"
        output: "zap_result.json"

    # 9️⃣ Upload des scans vers DefectDojo
    - name: Upload scans to DefectDojo
      env:
        DEFECTDOJO_URL: ${{ secrets.DEFECTDOJO_URL }}
        DEFECTDOJO_TOKEN: ${{ secrets.DEFECTDOJO_TOKEN }}
      run: |
        for item in \
          "semgrep_results.json:Semgrep JSON Report" \
          "npm_audit.json:NPM Audit JSON" \
          "zap_result.json:ZAP Scan"; do

          FILE=${item%%:*}
          TYPE=${item##*:}

          curl -X POST "$DEFECTDOJO_URL/api/v2/import-scan/" \
            -H "Authorization: Token $DEFECTDOJO_TOKEN" \
            -F "scan_type=$TYPE" \
            -F "file=@$FILE" \
            -F "engagement=$ENGAGEMENT_ID"
        done
